<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hammad's AI Study Hub | Birla Open Minds</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #00d2ff; --bg: #0b1120; --card: #1e293b; --text: #f8fafc; --ai-glow: #8b5cf6; --success: #10b981; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; min-height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar { width: 320px; background: #0f172a; padding: 25px; border-right: 1px solid #334155; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar h2 { color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 20px; }
        .xp-card { background: linear-gradient(135deg, #8b5cf6, #d946ef); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .nav-item { padding: 10px; color: #94a3b8; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 0.9rem; }
        .nav-item:hover { background: var(--card); color: white; }

        /* Main Content Styles */
        .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .search-area { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 1rem; }
        
        button { padding: 12px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-ai { background: var(--ai-glow); color: white; }
        .btn-quiz { background: #f59e0b; color: white; }
        .btn-report { background: #334155; color: white; margin-top: auto; }
        .btn-voice { background: var(--success); color: white; font-size: 0.8rem; padding: 5px 12px; }

        /* Chat Output */
        #output { flex: 1; }
        .message-bubble { background: #1e293b; border-radius: 15px; padding: 25px; margin-bottom: 20px; border-left: 5px solid var(--primary); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading { color: var(--primary); font-style: italic; display: none; margin-bottom: 10px; }
        .voice-select { background: #0f172a; color: white; border: 1px solid #334155; border-radius: 5px; padding: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div id="xp-display" class="xp-card">
            <div style="font-size: 0.8rem; opacity: 0.9;">Hammad's Study Rank</div>
            <div id="points" style="font-size: 1.5rem; font-weight: bold;">0 XP</div>
        </div>

        <h2>üìñ Subjects</h2>
        <div class="nav-item" onclick="setSubject('Math')">üî¢ Mathematics</div>
        <div class="nav-item" onclick="setSubject('Science')">üß¨ Science</div>
        <div class="nav-item" onclick="setSubject('Social Studies')">üåç Social Studies</div>

        <h2>üìã Parent's Tools</h2>
        <button class="btn-report" onclick="generateParentReport()">View Progress Report</button>
        <p style="font-size: 0.7rem; color: #64748b; margin-top: 15px; text-align: center;">Birla Open Minds | Zanskar Section</p>
    </div>

    <div class="main">
        <div class="search-area">
            <div class="input-group">
                <input type="text" id="userInput" placeholder="Hi Hammad! What did you learn in school today?">
                <button class="btn-ai" onclick="askGemini()">Talk to Teacher ‚ú®</button>
                <button class="btn-quiz" onclick="triggerQuiz()">Start Quiz üéÆ</button>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 0.8rem;">Teacher's Voice:</span>
                <select id="voiceSelect" class="voice-select"></select>
            </div>
        </div>

        <div id="ai-status" class="loading">Teacher is thinking... üß†</div>
        
        <div id="output">
            </div>
    </div>

    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script type="module">
  import { GoogleGenerativeAI } from "@google/generative-ai";

  // 1. REPLACED KEY - Paste your BRAND NEW key inside the quotes below
  const API_KEY = "PASTE_YOUR_NEW_KEY_HERE"; 
  const genAI = new GoogleGenerativeAI(API_KEY);
  
  let chatSession = null;
  let hammadPoints = parseInt(localStorage.getItem('hammadXP') || '0');
  let sessionHistory = JSON.parse(localStorage.getItem('hammadSession') || '[]');

  document.getElementById("points").innerText = `${hammadPoints} XP`;

  // 2. STABLE INITIALIZATION
  async function startTeacher() {
      try {
          // Force use of 1.5-flash-8b (The most 'free' and stable version available)
          const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-8b" });
          chatSession = model.startChat({
              history: [],
              generationConfig: { maxOutputTokens: 500 },
          });

          const intro = "You are a friendly Grade 5 tutor for Mohammad Hammad Bhat at Birla Open Minds school. Greet him and ask what he wants to learn today.";
          const result = await chatSession.sendMessage(intro);
          renderMessage("Teacher", result.response.text());
      } catch (err) {
          console.error("Critical Error:", err);
          // If even 1.5-flash fails, it's a regional or network block
          renderMessage("System", "Teacher is in a meeting. Please try again in 1 minute.");
      }
  }

  // 3. GLOBAL ASSIGNMENT (Fixes the 'not defined' error)
  window.askGemini = async function() {
      const inputField = document.getElementById("userInput");
      const input = inputField.value.trim();
      if (!input) return;

      document.getElementById("ai-status").style.display = "block";
      
      try {
          if (!chatSession) await startTeacher();
          const result = await chatSession.sendMessage(input);
          const responseText = result.response.text();

          renderMessage("Teacher", responseText);
          inputField.value = "";
      } catch (e) {
          console.error(e);
          // Check specifically for the 429 quota error
          if (e.message.includes('429')) {
              renderMessage("System", "Daily limit reached. Let's study from your books for a bit and come back later!");
          } else {
              renderMessage("System", "Connection error. Please check your internet.");
          }
      } finally {
          document.getElementById("ai-status").style.display = "none";
      }
  };

  window.triggerQuiz = () => {
      document.getElementById("userInput").value = "Give me a 3-question quiz!";
      window.askGemini();
  };

  // 4. UI FUNCTIONS
  function renderMessage(sender, text) {
      const output = document.getElementById("output");
      const div = document.createElement("div");
      div.className = "message-bubble";
      div.innerHTML = `
          <div style="display:flex; justify-content:space-between;">
              <strong style="color:var(--primary); font-size:0.8rem;">${sender.toUpperCase()}</strong>
              <button class="btn-voice" onclick="window.speak(this)">üîä Listen</button>
          </div>
          <div class="content">${marked.parse(text)}</div>
      `;
      output.prepend(div);
  }

  window.speak = (btn) => {
      window.speechSynthesis.cancel();
      const text = btn.parentElement.nextElementSibling.innerText;
      const utter = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(utter);
  }

  // BOOTSTRAP
  window.onload = startTeacher;
</script>
